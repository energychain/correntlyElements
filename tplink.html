<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Corrently - TP Link Kasa HS110 (EU)</title>
    <link rel="stylesheet" href="/assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
    <link rel="stylesheet" href="/assets/css/Footer-Basic.css">
    <link rel="stylesheet" href="/assets/css/header-1.css">
    <link rel="stylesheet" href="/assets/css/header-2.css">
    <link rel="stylesheet" href="/assets/css/header.css">
    <link rel="stylesheet" href="/assets/css/Navigation-Clean.css">
    <link rel="stylesheet" href="/assets/css/styles.css">
    <link rel="stylesheet" href="/assets/css/odometer-theme-car.css">
</head>

<body>
    <div class="shadow-lg" style="margin-bottom: 20px;">
        <nav class="navbar navbar-light navbar-expand-md navigation-clean" style="background-color: #ffffff;margin-bottom: 25px;">
            <div class="container"><a class="navbar-brand" style="color: #ffa700;font-family: Roboto, sans-serif;" href="/"><img style="filter: brightness(100%) contrast(102%) saturate(100%) sepia(0%);" src="/assets/img/corrently_logo.png"></a><button data-toggle="collapse" class="navbar-toggler"
                    data-target="#navcol-1"><span class="sr-only">Toggle navigation</span><span class="navbar-toggler-icon"></span></button>
            </div>
        </nav>
    </div>
    <div class="container">
      <div id="loggedout">
        <div class="card-deck" style="margin-bottom: 25px;">
            <div class="card shadow-lg">
                <div class="card-header text-dark bg-dark">
                    <h3 class="text-truncate text-light">TP-Link KASA Cloud Anmeldung</h3>
                </div>
                <div class="card-body" id="KASALoginForm">
                  <form action="https://api.corrently.io/core/tplink" method="POST" id="loginFrm">
                      <div class="form-group">
                        <label for="kasa_account">Email</label>
                        <input type="email" class="form-control" id="kasa_account" aria-describedby="emailHelp" placeholder="Email des KASA Cloud Accounts" name="kasa_account" >
                        <small id="emailHelp" class="form-text text-muted">Ihre Email-Adresse bei <a href="https://www.tplinkcloud.com" target="_blank">TP Link Cloud</a> oder APP.</small>
                     </div>
                     <div class="form-group">
                       <label for="kasa_password">Passwort</label>
                       <input type="password" class="form-control" id="kasa_password" aria-describedby="passwordHelp" placeholder="Passwort des KASA Cloud Accounts" name="kasa_password" >
                       <small id="passwordHelp" class="form-text text-muted">Passwort bei TP Link Cloud oder APP.</small>
                    </div>
                    <div class="form-group">
                      <label for="zip">Postleitzahl</label>
                      <input type="text" class="form-control" id="zip" aria-describedby="zipHelp" placeholder="Postleitzahl in Deutschland" name="zip" >
                      <small id="zipHelp" class="form-text text-muted">Postleitzahl, die zur Berechnung des GrünstromIndex verwendet wird.</small>
                    </div>
                     <button type="submit" class="btn btn-primary">Anmelden</button>
                   </form>
                </div>
                <div class="card-footer text-center">
                      <strong>Tipp:</strong><br/>Setzen Sie ein Lesezeichen auf diese Seite, nach der erfolgreichen Anmeldung!
                </div>
            </div>
        </div>
      </div>
      <div id="app">
      </div>
      <div id="loggedin">
        <div class="card-deck" style="margin-bottom: 25px;">
            <div class="card shadow-lg">
                <div class="card-header text-dark bg-dark">
                    <h3 class="text-truncate text-light">GrünstromIndex <span id="fortext"></span></h3>
                </div>
                <div class="card-body" id="gsi_card">

                </div>
            </div>
        </div>
        <div class="card-deck" style="margin-bottom: 25px;">


            <div class="card shadow-lg">
                <div class="card-header text-dark bg-dark">
                    <h3 class="text-truncate text-light">Grünstromanteil dieses SmartPlug</h3>
                </div>
                <div class="card-body" id="reading_chart">
                    <canvas class="usageChart" width="600" height="400"  data-chart="donut" id="usageChart"></canvas>
                    <table class="table table-striped"><tbody>
                  <tr><td>Stromverbrauch (letzte 24 Stunden)</td><td><span class="usageKwh"></span>&nbsp; kWh</td></tr>
                <tr><td>&nbsp;davon Grünstrom</td><td><span class="greenKwh"></span>&nbsp; kWh</td></tr>
                <tr><td>&nbsp;davon Reststrom</td><td><span class="greyKwh"></span>&nbsp; kWh</td></tr>
        </tbody></table>
                </div>
            </div>
            <div class="card shadow-lg">
                <div class="card-header text-dark bg-dark">
                    <h3 class="text-truncate text-light">Verwaltung <span id="vonalias"></span></h3>
                </div>
                <div class="card-body">
                     <h5>Zählerstände</h5>
                    <div id="reading_card">
                    </div>
                    <a id="skolink" class="btn btn-primary" target="_blank">Stromkonto</a>
                    <h5 style="margin-top:25px">Automatisch einschalten</h5>
                    <div id="switchTxt">
                    Zu Beginn der besten <select id="bestHours">
                      <option>1</option>
                      <option>2</option>
                      <option>3</option>
                      <option>4</option>
                      <option>5</option>
                      <option>6</option>
                      <option>7</option>
                      <option>8</option>
                      <option>9</option>
                      <option>10</option>
                      <option>11</option>
                      <option>12</option>
                    </select> Stunden.
                    <button type="button" class="btn btn-primary" id="switchBtn">setzen</button>
                  </div>
                </div>
            </div>
        </div>
        <div class="card shadow-lg">
            <div class="card-header text-dark bg-dark">
                <h3 class="text-truncate text-light">Verlauf des letzten Tages</h3>
            </div>
            <div class="card-body" id="reading_chart">
                <canvas class="usageChart" width="800" height="400" id="usageChart2"></canvas>
            </div>
        </div>
      </div>
    </div>

    <script src="/assets/js/jquery.min.js"></script>
    <script src="/assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="/assets/js/Chart.bundle.min.js"></script>
    <script src="/dist/correntlyElements-min.js"></script>
    <script>


    /* Funktionaler Code für dieses Beispiel */
    $(document).ready( function() {
      /* Fallunterscheidung für Eingabefeld Account */
      if($.getUrlVar("a") == null) {
        $('#loggedout').show();
        $('#loggedin').hide();
        $('#loginFrm').ajaxForm(function(d) {
          if(d.length>0) {
            if(typeof d[0].account != "undefined") {
              location.href="?a="+d[0].account;
            }
          }
        });
      } else {
        $('#loggedout').hide();
        $('#loggedin').show();
        $.getJSON("https://api.corrently.io/core/tplink?account="+$.getUrlVar("a"),function(data) {
              console.log(data[0]);
              let i = $.getUrlVar("i");
              if(i==null) i=0;
              $('#reading_card').correntlyOdoMeter(data[i].account); // Zählerstand für eingegebenen Zähler
              $('#usageChart').correntlyReadingChart(data[i].account);
              $('#usageChart2').correntlyReadingChart(data[i].account);
              $('#gsi_card').correntlyGSI(data[i].location.zip);
              $('#vonalias').html(data[i].alias);
              $('#skolink').attr('href',"https://www.stromkonto.net/?a="+data[i].account);
              $('#switchBtn').click(function() {
                $('#switchBtn').attr('disabled','disabled');

                let hours = $('#bestHours').val();
                $.getJSON("https://api.corrently.io/core/gsi?zip="+data[i].location.zip,function(gsidata) {

                  let gsisum_max=0;
                  let gsisum_start=0;
                  for(let j=0;j<gsidata.forecast.length-hours;j++) {
                      let gsisum=0;
                      for(let k=0;k<hours;k++) {
                          gsisum+=gsidata.forecast[j+k].gsi;
                      }
                      if(gsisum>gsisum_max) {
                        gsisum_max = gsisum;
                        gsisum_start = gsidata.forecast[j].timeStamp;
                      }
                  }
                  $.getJSON("https://api.corrently.io/core/tplink?account="+$.getUrlVar("a")+"&activate="+data[i].deviceMac+"&ts="+gsisum_start,function(data) {
                    $('#switchBtn').removeAttr('disabled');
                    $('#switchTxt').html("Gerät wird automatisch eingeschaltet nach "+new Date(gsisum_start).toLocaleString()+".");
                  });
                })

              })
          //}
        });

      }

    });
    </script>
</body>

</html>
